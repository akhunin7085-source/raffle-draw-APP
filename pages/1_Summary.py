import streamlit as st
import pandas as pd
import os
import io

# ----------------------------------------------------
# --- CONFIGURATION & FILE PATHS ---
# ----------------------------------------------------
HISTORY_FILE = 'draw_history.csv'
EMPLOYEE_FILE = 'employees.csv' # ‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö

# ----------------------------------------------------
# *** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢: Load Data Helper (History) ***
# ----------------------------------------------------
def load_history():
    """‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏•‡∏™‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô"""
    if os.path.exists(HISTORY_FILE):
        try:
            # ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢ encoding
            try:
                 df = pd.read_csv(HISTORY_FILE, encoding='utf-8-sig')
            except UnicodeDecodeError:
                 df = pd.read_csv(HISTORY_FILE, encoding='utf-8')

            required_cols = ['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç', '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', '‡πÅ‡∏ú‡∏ô‡∏Å']
            for col in required_cols:
                if col not in df.columns:
                    df[col] = ''
            
            # ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£ Merge ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            df['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] = df['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'].astype(str).str.strip() 

            return df.fillna('')
        except Exception as e:
            st.error(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ {HISTORY_FILE} ‡πÑ‡∏î‡πâ: {e}")
            return pd.DataFrame()
    else:
        return pd.DataFrame()

# ----------------------------------------------------
# *** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢: Load Data Helper (Employees) ***
# ----------------------------------------------------
@st.cache_data(show_spinner=False)
def load_employees_for_merge():
    """‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (employees.csv) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°"""
    if os.path.exists(EMPLOYEE_FILE):
        try:
            # ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢ encoding
            try:
                df = pd.read_csv(EMPLOYEE_FILE, encoding='utf-8-sig')
            except UnicodeDecodeError:
                df = pd.read_csv(EMPLOYEE_FILE, encoding='cp874')
            except Exception:
                 df = pd.read_csv(EMPLOYME_FILE, encoding='utf-8')
            
            if '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•' in df.columns and '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•' in df.columns:
                df['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] = df['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'].astype(str).str.strip()
                df['‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•'] = df['‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•'].astype(str).str.strip()
                
                # 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏° (Index ‡∏Ñ‡∏∑‡∏≠‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)
                df['_original_order'] = df.index
                
                # 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°
                df['_rank_within_group'] = df.groupby('‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•')['_original_order'].rank(method='dense', ascending=True).astype(int)
                
                return df[['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', '_original_order', '_rank_within_group']]
            else:
                st.warning(f"‡πÑ‡∏ü‡∏•‡πå {EMPLOYEE_FILE} ‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•' ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ")
                return pd.DataFrame()

        except Exception as e:
            st.error(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô {EMPLOYEE_FILE} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ: {e}")
            return pd.DataFrame()
    else:
        return pd.DataFrame()


# ----------------------------------------------------
# *** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢: to_excel_bytes ***
# ----------------------------------------------------
def to_excel_bytes(df):
    """‡πÅ‡∏õ‡∏•‡∏á DataFrame ‡πÄ‡∏õ‡πá‡∏ô Excel (.xlsx) bytes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î"""
    # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°, ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•, ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç, ‡πÅ‡∏ú‡∏ô‡∏Å
    cols_to_keep = ['‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°', '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç', '‡πÅ‡∏ú‡∏ô‡∏Å']
    
    # ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    df_download = df.rename(columns={'_rank_within_group': '‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°'})
    df_download = df_download.drop(columns=['_original_order'], errors='ignore')
    
    # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
    final_cols = [col for col in cols_to_keep if col in df_download.columns]
    df_download = df_download[final_cols]
    
    # ‡πÉ‡∏ä‡πâ BytesIO ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df_download.to_excel(writer, index=False, sheet_name='‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•')
    
    processed_data = output.getvalue()
    return processed_data

# ----------------------------------------------------
# --- Main Program (Streamlit UI) ---
# ----------------------------------------------------
st.set_page_config(
    layout="wide",
    page_title="‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
    initial_sidebar_state="collapsed"
)

# --- CSS Styling for Prize Cards ---
st.markdown("""
<style>
/* Custom CSS for the Prize Card Layout */
.prize-card {
    background-color: #1a1a1a; 
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 5px solid #ff4b4b; /* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    height: 100%;
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ Card ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
}

/* *** NEW: ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á Card ‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• *** */
.prize-header {
    display: flex;
    justify-content: space-between; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ */
    align-items: center;
    margin-bottom: 10px;
    border-bottom: 1px solid #333333;
    padding-bottom: 5px;
}
.prize-name {
    font-size: 1.8em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
    font-weight: bold;
    color: #ffd700; 
}
.prize-rank {
    font-size: 1.5em; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö */
    font-weight: bold;
    color: #ff4b4b; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô */
}
/* ----------------------------------------------- */

.winner-name {
    font-size: 1.5em; /* ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô: ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ */
    font-weight: bold;
    color: #4beaff; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠ */
    margin-top: 5px;
}
.group-info {
    font-size: 1.0em; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏î‡∏¥‡∏°: ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô/‡πÅ‡∏ú‡∏ô‡∏Å */
    color: #cccccc;
    margin-top: 5px;
}
/* *** NEW: ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏ü *** */
.group-separator {
    margin-top: 25px; 
    margin-bottom: 10px;
    font-size: 1.8em;
    font-weight: bold;
    color: #ffd700;
}
</style>
""", unsafe_allow_html=True)


st.title("üèÜ ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
st.markdown("---")

df_history = load_history()

if df_history.empty or df_history['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç'].dropna().empty:
    st.warning("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß")
else:
    # ------------------------------------------------
    # *** 1. MERGE ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°) ***
    # ------------------------------------------------
    df_employees = load_employees_for_merge()
    
    if not df_employees.empty:
        # Merge ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
        df_merged = pd.merge(
            df_history, 
            df_employees, 
            on='‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', 
            how='left',
            suffixes=('_hist', '_emp')
        )
        
        # ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•' ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏° '_rank_within_group' (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1, 2, 3...)
        df_display = df_merged.sort_values(
            by=['‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•_hist', '_rank_within_group'], 
            na_position='last'
        ).reset_index(drop=True)
        
        # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        df_display = df_display.rename(columns={'‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•_hist': '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•'})
        df_display = df_display.drop(columns=['‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•_emp'], errors='ignore')
    else:
        st.info("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏ó‡∏ô")
        df_display = df_history.sort_values(by=['‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç']).reset_index(drop=True)
    
    # ------------------------------------------------
    # ** 2. ‡∏™‡πà‡∏ß‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (‡πÄ‡∏õ‡πá‡∏ô Excel) **
    # ------------------------------------------------
    st.download_button(
        label="‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (Excel .xlsx)",
        data=to_excel_bytes(df_display), 
        file_name=f'prize_summary_{pd.Timestamp.now().strftime("%Y%m%d_%H%M%S")}.xlsx',
        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        use_container_width=True,
        type="primary"
    )
    st.markdown("---")
    
    # ------------------------------------------------
    # 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Card View (2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
    # ------------------------------------------------
    st.header(f"üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({len(df_display)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) [‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô]")
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á Grid View (2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
    cols = st.columns(2)
    
    # ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    current_group = None
    
    # ‡πÉ‡∏ä‡πâ List of Tuples ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö HTML ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Card ‡πÅ‡∏•‡∏∞ Header
    output_elements = []

    for i in range(len(df_display)):
        row = df_display.iloc[i]
        
        # *** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° ***
        if row['‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•'] != current_group:
            current_group = row['‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•']
            # ‡πÄ‡∏û‡∏¥‡πà‡∏° Header ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            header_html = f'<div class="group-separator">‚û°Ô∏è ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: {current_group}</div>'
            output_elements.append(('header', header_html))
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á Card HTML
        rank_value = row['_rank_within_group'] if '_rank_within_group' in row else 'N/A'
        
        card_html = f"""
        <div class="prize-card">
            <div class="prize-header">
                <span class="prize-name">üéÅ {row['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç']}</span>
                <span class="prize-rank">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà {rank_value}</span>
            </div>
            <div>
                <span class="winner-name">üë§ {row['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}</span><br>
                <span class="group-info">üè¢ ‡πÅ‡∏ú‡∏ô‡∏Å: {row.get('‡πÅ‡∏ú‡∏ô‡∏Å', 'N/A')}</span>
            </div>
        </div>
        """
        output_elements.append(('card', card_html))
        
    # *** NEW: ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á Card ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏°‡∏≠‡∏Å‡∏±‡∏ô (Grid Coherence) ***
    # ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á Header ‡πÅ‡∏•‡∏∞ Card ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ st.markdown ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á
    
    col_a = []
    col_b = []
    current_col = col_a
    
    for element_type, html_content in output_elements:
        if element_type == 'header':
            # Header ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Col A ‡πÅ‡∏•‡πâ‡∏ß Col B ‡∏ß‡πà‡∏≤‡∏á)
            col_a.append(html_content)
            col_b.append("<div style='height: 1px; margin-bottom: 20px;'></div>") # ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
            current_col = col_a # ‡πÄ‡∏£‡∏¥‡πà‡∏° Card ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Col A ‡πÄ‡∏™‡∏°‡∏≠‡∏´‡∏•‡∏±‡∏á Header
        else: # type == 'card'
            current_col.append(html_content)
            # ‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Card ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            current_col = col_b if current_col == col_a else col_a

    # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    with cols[0]:
        st.markdown('\n'.join(col_a), unsafe_allow_html=True)
    with cols[1]:
        st.markdown('\n'.join(col_b), unsafe_allow_html=True)
        
    st.markdown("---")
