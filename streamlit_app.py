import streamlit as st
import pandas as pd
import random
import time
import io
from datetime import datetime
import os
import base64
import qrcode
import json
import urllib.parse
import numpy as np
import warnings

# р╣Ар╕Юр╕╖р╣Ир╕нр╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щ UserWarning р╕Ир╕▓р╕Б openpyxl р╣Ар╕бр╕╖р╣Ир╕нр╕нр╣Ир╕▓р╕Щр╣Др╕Яр╕ер╣М Excel
warnings.filterwarnings('ignore', category=UserWarning, module='openpyxl')

# ----------------------------------------------------
# --- CONFIGURATION & FILE PATHS ---
# ----------------------------------------------------
HISTORY_FILE = 'draw_history.csv'
EMPLOYEE_FILE = 'employees.csv' # р╣Др╕Яр╕ер╣Мр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ (р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕гр╕Ур╕╡р╣Др╕бр╣Ир╕бр╕╡р╕Бр╕▓р╕гр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф)
PRIZE_FILE = 'prizes.csv' # р╣Др╕Яр╕ер╣Мр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ (р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕гр╕Ур╕╡р╣Др╕бр╣Ир╕бр╕╡р╕Бр╕▓р╕гр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф)

# ----------------------------------------------------
# --- FUNCTIONS ---
# ----------------------------------------------------

def save_history(history_list):
    """р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Ьр╕ер╕кр╕╕р╣Ир╕бр╕ер╕Зр╣Гр╕Щр╣Др╕Яр╕ер╣М CSV р╕нр╕вр╣Ир╕▓р╕Зр╕Цр╕▓р╕зр╕г (р╣Ар╕Чр╣Ир╕▓р╕Чр╕╡р╣И Streamlit Cloud р╕Ир╕░р╕нр╕Щр╕╕р╕Нр╕▓р╕Х)"""
    required_cols = ['р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е', 'р╣Бр╕Ьр╕Щр╕Б', 'р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н', 'р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е']

    if not history_list:
        df_history = pd.DataFrame(columns=required_cols)┬а
┬а ┬а else:
┬а ┬а ┬а ┬а df_history = pd.DataFrame(history_list)
┬а ┬а ┬а ┬а for col in required_cols:
┬а ┬а ┬а ┬а ┬а ┬а ┬аif col not in df_history.columns:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬аdf_history[col] = ''
┬а ┬а ┬а ┬а┬а
┬а ┬а try:
┬а ┬а ┬а ┬а # р╕Бр╕▓р╕гр╣Ар╕Вр╕╡р╕вр╕Щр╣Др╕Яр╕ер╣М draw_history.csv р╕вр╕▒р╕Зр╕Др╕Зр╕Хр╣Йр╕нр╕Зр╕Чр╕│ р╣Бр╕Хр╣Ир╣Др╕бр╣Ир╕гр╕▒р╕Ър╕Ыр╕гр╕░р╕Бр╕▒р╕Щр╕Др╕зр╕▓р╕бр╕Др╕Зр╕Чр╕Щ
┬а ┬а ┬а ┬а df_history.to_csv(HISTORY_FILE, index=False, encoding='utf_8_sig')┬а
┬а ┬а except Exception as e:
┬а ┬а ┬а ┬а print(f"ERROR: р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Ьр╕ер╕кр╕╕р╣Ир╕бр╕ер╕Зр╣Гр╕Щр╣Др╕Яр╕ер╣Мр╣Др╕Фр╣Й: {e}")┬а

@st.cache_data(show_spinner=False)┬а
def load_data(emp_file=EMPLOYEE_FILE, prize_file=PRIZE_FILE):
┬а ┬а """р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣М CSV р╕Ър╕Щр╕Фр╕┤р╕кр╕Бр╣М (р╣Гр╕Кр╣Йр╣Ар╕Йр╕Юр╕▓р╕░р╕Хр╕нр╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╣Бр╕нр╕Ыр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ)"""
┬а ┬а employee_data = pd.DataFrame()┬а
┬а ┬а prize_data = pd.DataFrame()┬а
┬а ┬а┬а
┬а ┬а st.info("р╕Бр╕│р╕ер╕▒р╕Зр╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣М CSV р╕Ър╕Щр╕Фр╕┤р╕кр╕Бр╣М...")
┬а ┬а┬а
┬а ┬а # 1. р╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣Мр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щ
┬а ┬а if os.path.exists(emp_file):
┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а employee_data = pd.read_csv(emp_file, encoding='utf-8-sig') # р╣Гр╕Кр╣Й utf-8-sig р╣Бр╕Бр╣Йр╕Ыр╕▒р╕Нр╕лр╕▓ BOM
┬а ┬а ┬а ┬а except Exception as e:
┬а ┬а ┬а ┬а ┬а ┬а st.error(f"ERROR: р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕нр╣Ир╕▓р╕Щр╣Др╕Яр╕ер╣М {emp_file} р╣Др╕Фр╣Й: {e}")
┬а ┬а┬а
┬а ┬а # 2. р╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣Мр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н
┬а ┬а if os.path.exists(prize_file):
┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а prize_data = pd.read_csv(prize_file, encoding='utf-8-sig')┬а
┬а ┬а ┬а ┬а except Exception as e:
┬а ┬а ┬а ┬а ┬а ┬а st.error(f"ERROR: р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕нр╣Ир╕▓р╕Щр╣Др╕Яр╕ер╣М {prize_file} р╣Др╕Фр╣Й: {e}")
┬а ┬а┬а

┬а ┬а # 3. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕зр╕▓р╕бр╕кр╕бр╕Ър╕╣р╕гр╕Ур╣Мр╕Вр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕ер╕░р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ
┬а ┬а if employee_data.empty or prize_data.empty:
┬а ┬а ┬а ┬а return pd.DataFrame(), pd.DataFrame()
┬а ┬а ┬а ┬а┬а
┬а ┬а required_emp_cols = ['р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е', 'р╣Бр╕Ьр╕Щр╕Б', 'р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е']
┬а ┬а required_prize_cols = ['р╕Кр╕╖р╣Ир╕нр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н', 'р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е', 'р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н']┬а
┬а ┬а┬а
┬а ┬а if not all(col in employee_data.columns for col in required_emp_cols):
┬а ┬а ┬а ┬а st.error(f"р╣Др╕Яр╕ер╣Мр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щр╕Вр╕▓р╕Фр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ: {', '.join(required_emp_cols)}")
┬а ┬а ┬а ┬а return pd.DataFrame(), pd.DataFrame()
┬а ┬а ┬а ┬а┬а
┬а ┬а if not all(col in prize_data.columns for col in required_prize_cols):
┬а ┬а ┬а ┬а st.error(f"р╣Др╕Яр╕ер╣Мр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Нр╕Вр╕▓р╕Фр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ: {', '.join(required_prize_cols)}")
┬а ┬а ┬а ┬а return pd.DataFrame(), pd.DataFrame()

┬а ┬а try:
┬а ┬а ┬а ┬а prize_data['р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н'] = pd.to_numeric(
┬а ┬а ┬а ┬а ┬а ┬а prize_data['р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н'],┬а
┬а ┬а ┬а ┬а ┬а ┬а errors='coerce'
┬а ┬а ┬а ┬а ).fillna(0).astype(int)
┬а ┬а except:
┬а ┬а ┬а ┬а st.error("р╕Др╕нр╕ер╕▒р╕бр╕Щр╣М 'р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н' р╣Гр╕Щ prizes.csv р╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╣Зр╕Щр╕Хр╕▒р╕зр╣Ар╕ер╕В")
┬а ┬а ┬а ┬а return pd.DataFrame(), pd.DataFrame()
┬а ┬а ┬а ┬а┬а
┬а ┬а if 'р╕кр╕Цр╕▓р╕Щр╕░' not in employee_data.columns:
┬а ┬а ┬а ┬а employee_data['р╕кр╕Цр╕▓р╕Щр╕░'] = 'р╕Юр╕гр╣Йр╕нр╕бр╕кр╕╕р╣Ир╕б'
┬а ┬а ┬а ┬а┬а
┬а ┬а st.success("р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕кр╕│р╣Ар╕гр╣Зр╕И! (р╕лр╕▓р╕Бр╣Др╕Яр╕ер╣Мр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕бр╕╡р╕нр╕вр╕╣р╣И)")
┬а ┬а return employee_data, prize_data┬а

def reset_application():
┬а ┬а """р╕гр╕╡р╣Ар╕Лр╣Зр╕Х Session State, р╕ер╣Йр╕▓р╕Зр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤ р╣Бр╕ер╕░р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╣Гр╕лр╕бр╣И"""
┬а ┬а if os.path.exists(HISTORY_FILE):
┬а ┬а ┬а ┬а os.remove(HISTORY_FILE)
┬а ┬а ┬а ┬а┬а
┬а ┬а st.cache_data.clear()┬а
┬а ┬а st.session_state.emp_df, st.session_state.prize_df = load_data()┬а
┬а ┬а st.session_state.draw_history = []
┬а ┬а st.session_state.selected_group = None┬а
┬а ┬а st.success("тЬЕ р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╣Бр╕ер╕░р╕ер╣Йр╕▓р╕Зр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕кр╕╕р╣Ир╕бр╕кр╕│р╣Ар╕гр╣Зр╕И! р╣Вр╕Ыр╕гр╕Фр╕гр╕нр╣Вр╕лр╕ер╕Фр╕лр╕Щр╣Йр╕▓р╕Ир╕нр╣Гр╕лр╕бр╣И")
┬а ┬а time.sleep(1)
┬а ┬а st.rerun()

def to_csv_bytes(df):
┬а ┬а """р╣Бр╕Ыр╕ер╕З DataFrame р╣Ар╕Ыр╣Зр╕Щ CSV bytes р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Ф"""
┬а ┬а csv_bytes = df.to_csv(index=False, encoding='utf_8_sig').encode('utf-8')
┬а ┬а return csv_bytes

def run_draw(group, emp_df, prize_df):
┬а ┬а """р╕Чр╕│р╕Бр╕▓р╕гр╕кр╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Б"""
┬а ┬а group_clean = str(group).strip()
┬а ┬а available_employees = emp_df[(emp_df['р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е'] == group_clean) & (emp_df['р╕кр╕Цр╕▓р╕Щр╕░'] == 'р╕Юр╕гр╣Йр╕нр╕бр╕кр╕╕р╣Ир╕б')]
┬а ┬а available_prizes = prize_df[(prize_df['р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е'] == group_clean) & (prize_df['р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н'] > 0)]
┬а ┬а┬а
┬а ┬а prize_list = []
┬а ┬а for index, row in available_prizes.iterrows():
┬а ┬а ┬а ┬а prize_list.extend([row['р╕Кр╕╖р╣Ир╕нр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н']] * row['р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н'])
┬а ┬а ┬а ┬а┬а
┬а ┬а max_draws = min(len(available_employees), len(prize_list))
┬а ┬а┬а
┬а ┬а if max_draws == 0:
┬а ┬а ┬а ┬а st.error(f"р╕Бр╕ер╕╕р╣Ир╕б {group}: р╣Др╕бр╣Ир╕бр╕╡р╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щр╕Чр╕╡р╣Ир╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕кр╕╕р╣Ир╕б р╕лр╕гр╕╖р╕нр╣Др╕бр╣Ир╕бр╕╡р╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Нр╣Ар╕лр╕ер╕╖р╕нр╣Бр╕ер╣Йр╕з")
┬а ┬а ┬а ┬а return []
┬а ┬а ┬а ┬а┬а
┬а ┬а selected_employee_data = available_employees[['р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е', 'р╣Бр╕Ьр╕Щр╕Б']].sample(max_draws)
┬а ┬а selected_employees = selected_employee_data.values.tolist()┬а
┬а ┬а selected_prizes = random.sample(prize_list, max_draws)
┬а ┬а┬а
┬а ┬а results = list(zip(selected_employees, selected_prizes))
┬а ┬а return results

def get_base64_image(image_file):
┬а ┬а """р╣Бр╕Ыр╕ер╕Зр╣Др╕Яр╕ер╣Мр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Ар╕Ыр╣Зр╕Щ Base64 р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Гр╕Кр╣Йр╣Гр╕Щ CSS (р╕Юр╕╖р╣Йр╕Щр╕лр╕ер╕▒р╕З)"""
┬а ┬а try:
┬а ┬а ┬а ┬а with open(image_file, "rb") as f:
┬а ┬а ┬а ┬а ┬а ┬а data = base64.b64encode(f.read()).decode("utf-8")
┬а ┬а ┬а ┬а if image_file.lower().endswith(('.png')):
┬а ┬а ┬а ┬а ┬а ┬а mime_type = 'image/png'
┬а ┬а ┬а ┬а elif image_file.lower().endswith(('.jpg', '.jpeg')):
┬а ┬а ┬а ┬а ┬а ┬а mime_type = 'image/jpeg'
┬а ┬а ┬а ┬а else:
┬а ┬а ┬а ┬а ┬а ┬а mime_type = 'image/jpg'┬а
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а return f"data:image/{mime_type};base64,{data}"
┬а ┬а except FileNotFoundError:
┬а ┬а ┬а ┬а return None
┬а ┬а except Exception as e:
┬а ┬а ┬а ┬а # р╣Др╕бр╣Ир╣Бр╕кр╕Фр╕З error р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╣Гр╕Кр╣Ир╣Др╕Яр╕ер╣Мр╕лр╕ер╕▒р╕Б (р╣Ар╕Кр╣Ир╕Щ background)
┬а ┬а ┬а ┬а return None
┬а ┬а ┬а ┬а┬а
# ----------------------------------------------------
# --- Main Program (Streamlit UI) ---
# ----------------------------------------------------
def main():
┬а ┬а┬а
┬а ┬а st.set_page_config(
┬а ┬а ┬а ┬а layout="wide",
┬а ┬а ┬а ┬а page_title="р╕кр╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕ер╕Ыр╕╡р╣Гр╕лр╕бр╣И 2568",┬а
┬а ┬а ┬а ┬а initial_sidebar_state="collapsed"
┬а ┬а )
┬а ┬а┬а
┬а ┬а # ----------------------------------------------------
┬а ┬а # 1. р╣Вр╕лр╕ер╕Фр╣Бр╕ер╕░р╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щ Session State┬а
┬а ┬а # ----------------------------------------------------
┬а ┬а if 'emp_df' not in st.session_state:
┬а ┬а ┬а ┬а st.session_state.emp_df, st.session_state.prize_df = load_data()┬а
┬а ┬а ┬а ┬а st.session_state.draw_history = []┬а
┬а ┬а ┬а ┬а st.session_state.selected_group = None┬а
┬а ┬а┬а
┬а ┬а if 'draw_history' not in st.session_state:
┬а ┬а ┬а ┬а # р╕лр╕▓р╕Б draw_history р╕лр╕▓р╕вр╣Др╕Ы р╣Гр╕лр╣Йр╕кр╕гр╣Йр╕▓р╕Зр╣Гр╕лр╕бр╣Ир╣Бр╕ер╕░р╕ер╕нр╕Зр╣Вр╕лр╕ер╕Фр╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣М (р╕Бр╕гр╕Ур╕╡ app crash)
┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а ┬аif os.path.exists(HISTORY_FILE):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.draw_history = pd.read_csv(HISTORY_FILE).to_dict('records')
┬а ┬а ┬а ┬а ┬а ┬а ┬аelse:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.draw_history = []
┬а ┬а ┬а ┬а except:
┬а ┬а ┬а ┬а ┬а ┬а ┬аst.session_state.draw_history = []

┬а ┬а┬а
┬а ┬а with st.sidebar:
┬а ┬а ┬а ┬а st.header("тЪЩя╕П р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕е")
┬а ┬а ┬а ┬а default_title = "ЁЯОЙ р╕кр╕╕р╣Ир╕бр╕Вр╕зр╕▒р╕Нр╕Ыр╕╡р╣Гр╕лр╕бр╣И 2568 ЁЯОБ"┬а
┬а ┬а ┬а ┬а custom_title = st.text_input("р╕Кр╕╖р╣Ир╕н/р╕лр╕▒р╕зр╕Вр╣Йр╕нр╣Вр╕Ыр╕гр╣Бр╕Бр╕гр╕б:", value=default_title)
┬а ┬а ┬а ┬а st.markdown("---")
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а # *** р╕кр╣Ир╕зр╕Щр╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Фр╣Ар╕Чр╕бр╣Ар╕Юр╕ер╕Х (р╣Ар╕лр╕бр╕╖р╕нр╕Щр╣Ар╕Фр╕┤р╕б) ***
┬а ┬а ┬а ┬а st.markdown("### тмЗя╕П р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Фр╣Ар╕Чр╕бр╣Ар╕Юр╕ер╕Х")
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а # 1. р╣Ар╕Чр╕бр╣Ар╕Юр╕ер╕Хр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щ
┬а ┬а ┬а ┬а emp_template = pd.DataFrame({
┬а ┬а ┬а ┬а ┬а ┬а 'р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е': ['р╕кр╕бр╕Кр╕▓р╕в р╣Гр╕Ир╕Фр╕╡', 'р╕кр╕бр╕лр╕Нр╕┤р╕З р╕кр╕╕р╕Вр╣Гр╕И'],
┬а ┬а ┬а ┬а ┬а ┬а 'р╣Бр╕Ьр╕Щр╕Б': ['HR', 'IT'],
┬а ┬а ┬а ┬а ┬а ┬а 'р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е': ['р╕нр╕▓р╕вр╕╕р╕Зр╕▓р╕Щ 1-5 р╕Ыр╕╡', 'р╕нр╕▓р╕вр╕╕р╕Зр╕▓р╕Щ 20 р╕Ыр╕╡р╕Вр╕╢р╣Йр╕Щр╣Др╕Ы'],
┬а ┬а ┬а ┬а ┬а ┬а 'р╕кр╕Цр╕▓р╕Щр╕░': ['р╕Юр╕гр╣Йр╕нр╕бр╕кр╕╕р╣Ир╕б', 'р╕Юр╕гр╣Йр╕нр╕бр╕кр╕╕р╣Ир╕б']
┬а ┬а ┬а ┬а })
┬а ┬а ┬а ┬а st.download_button(
┬а ┬а ┬а ┬а ┬а ┬а label="ЁЯУДр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щ",
┬а ┬а ┬а ┬а ┬а ┬а data=to_csv_bytes(emp_template),
┬а ┬а ┬а ┬а ┬а ┬а file_name='employees_template.csv',
┬а ┬а ┬а ┬а ┬а ┬а mime='text/csv'
┬а ┬а ┬а ┬а )
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а # 2. р╣Ар╕Чр╕бр╣Ар╕Юр╕ер╕Хр╕Вр╕нр╕Зр╕гр╕▓р╕Зр╕зр╕▒р╕е┬а
┬а ┬а ┬а ┬а prize_template = pd.DataFrame({
┬а ┬а ┬а ┬а ┬а ┬а 'р╕Кр╕╖р╣Ир╕нр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н': ['р╕Хр╕▒р╣Лр╕зр╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕Ър╕┤р╕Щ', 'р╕Юр╕▒р╕Фр╕ер╕б', 'р╕Чр╕╡р╕зр╕╡ 55 р╕Щр╕┤р╣Йр╕з'],
┬а ┬а ┬а ┬а ┬а ┬а 'р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е': ['р╕нр╕▓р╕вр╕╕р╕Зр╕▓р╕Щ 1-5 р╕Ыр╕╡', 'р╕нр╕▓р╕вр╕╕р╕Зр╕▓р╕Щ 1-5 р╕Ыр╕╡', 'р╕нр╕▓р╕вр╕╕р╕Зр╕▓р╕Щ 20 р╕Ыр╕╡р╕Вр╕╢р╣Йр╕Щр╣Др╕Ы'],
┬а ┬а ┬а ┬а ┬а ┬а 'р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н': [3, 10, 1]
┬а ┬а ┬а ┬а })
┬а ┬а ┬а ┬а st.download_button(
┬а ┬а ┬а ┬а ┬а ┬а label="ЁЯОБр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н",
┬а ┬а ┬а ┬а ┬а ┬а data=to_csv_bytes(prize_template),
┬а ┬а ┬а ┬а ┬а ┬а file_name='prizes_template.csv',
┬а ┬а ┬а ┬а ┬а ┬а mime='text/csv'
┬а ┬а ┬а ┬а )
┬а ┬а ┬а ┬а st.markdown("---")


┬а ┬а ┬а ┬а # *** р╕кр╣Ир╕зр╕Щр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣Мр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕лр╕бр╣И (р╕гр╕нр╕Зр╕гр╕▒р╕Ъ CSV/Excel) ***
┬а ┬а ┬а ┬а st.markdown("### тмЖя╕П р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕лр╕бр╣И")
┬а ┬а ┬а ┬а uploaded_type = ['csv', 'xlsx', 'xls']
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а uploaded_emp = st.file_uploader(
┬а ┬а ┬а ┬а ┬а ┬а "р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф Employee File",┬а
┬а ┬а ┬а ┬а ┬а ┬а type=uploaded_type,┬а
┬а ┬а ┬а ┬а ┬а ┬а key='uploaded_emp_file'
┬а ┬а ┬а ┬а )
┬а ┬а ┬а ┬а uploaded_prize = st.file_uploader(
┬а ┬а ┬а ┬а ┬а ┬а "р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф Prize File",┬а
┬а ┬а ┬а ┬а ┬а ┬а type=uploaded_type,┬а
┬а ┬а ┬а ┬а ┬а ┬а key='uploaded_prize_file'
┬а ┬а ┬а ┬а )
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а def read_uploaded_file(uploaded_file):
┬а ┬а ┬а ┬а ┬а ┬а """р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Кр╣Ир╕зр╕вр╕нр╣Ир╕▓р╕Щр╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф р╕гр╕нр╕Зр╕гр╕▒р╕Ъ CSV (р╕лр╕ер╕▓р╕в encoding) р╣Бр╕ер╕░ Excel"""
┬а ┬а ┬а ┬а ┬а ┬а if uploaded_file is None:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return None
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а file_ext = uploaded_file.name.split('.')[-1].lower()
┬а ┬а ┬а ┬а ┬а ┬а uploaded_file.seek(0)
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if file_ext in ['xlsx', 'xls']:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return pd.read_excel(uploaded_file)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а elif file_ext == 'csv':
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # р╕ер╕нр╕Зр╕лр╕ер╕▓р╕в Encoding р╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕Бр╣Йр╕Ыр╕▒р╕Нр╕лр╕▓ 'invalid start byte'
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return pd.read_csv(uploaded_file, encoding='utf-8')
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а except UnicodeDecodeError:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а uploaded_file.seek(0)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return pd.read_csv(uploaded_file, encoding='cp874')
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а except:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а uploaded_file.seek(0)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return pd.read_csv(uploaded_file, encoding='utf-8-sig')
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а else:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return None
┬а ┬а ┬а ┬а ┬а ┬а except Exception as e:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а raise e # р╕кр╣Ир╕З Exception р╕Хр╣Ир╕нр╣Др╕Ыр╣Гр╕лр╣Йр╕кр╣Ир╕зр╕Щр╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Йр╕Ир╕▒р╕Фр╕Бр╕▓р╕г
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а # р╣Гр╕Кр╣Йр╕Ыр╕╕р╣Ир╕бр╣Ар╕Фр╕╡р╕вр╕зр╣Гр╕Щр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф
┬а ┬а ┬а ┬а if st.button("р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е", key='upload_reload_btn', type="primary"):
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а uploaded_count = 0
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а # A. р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╣Др╕Яр╕ер╣Мр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щ
┬а ┬а ┬а ┬а ┬а ┬а if uploaded_emp is not None:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а new_emp_df = read_uploaded_file(uploaded_emp)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if new_emp_df is None:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬аst.error("р╣Др╕бр╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ър╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╣Др╕Яр╕ер╣Мр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щ")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕кр╕│р╕Др╕▒р╕Н
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а required_emp_cols = ['р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е', 'р╣Бр╕Ьр╕Щр╕Б', 'р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е']
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if new_emp_df is not None and not all(col in new_emp_df.columns for col in required_emp_cols):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.error(f"р╣Др╕Яр╕ер╣Мр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щр╕Вр╕▓р╕Фр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ: {', '.join(required_emp_cols)}")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а elif new_emp_df is not None:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if 'р╕кр╕Цр╕▓р╕Щр╕░' not in new_emp_df.columns:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а new_emp_df['р╕кр╕Цр╕▓р╕Щр╕░'] = 'р╕Юр╕гр╣Йр╕нр╕бр╕кр╕╕р╣Ир╕б'
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.emp_df = new_emp_df # р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕Вр╣Йр╕▓ Session State р╣Вр╕Фр╕вр╕Хр╕гр╕З
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.success("р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╣Др╕Яр╕ер╣Мр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щр╕кр╕│р╣Ар╕гр╣Зр╕И!")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а uploaded_count += 1
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а except Exception as e:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.error(f"р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕нр╣Ир╕▓р╕Щр╣Др╕Яр╕ер╣Мр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щ: {e}")

┬а ┬а ┬а ┬а ┬а ┬а # B. р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╣Др╕Яр╕ер╣Мр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н
┬а ┬а ┬а ┬а ┬а ┬а if uploaded_prize is not None:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а new_prize_df = read_uploaded_file(uploaded_prize)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if new_prize_df is None:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬аst.error("р╣Др╕бр╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ър╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╣Др╕Яр╕ер╣Мр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╣Бр╕ер╕░р╣Бр╕Ыр╕ер╕Зр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Вр╣Йр╕нр╕бр╕╣р╕е
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а required_prize_cols = ['р╕Кр╕╖р╣Ир╕нр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н', 'р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е', 'р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н']┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if new_prize_df is not None and not all(col in new_prize_df.columns for col in required_prize_cols):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.error(f"р╣Др╕Яр╕ер╣Мр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Нр╕Вр╕▓р╕Фр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ: {', '.join(required_prize_cols)}")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а elif new_prize_df is not None:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а new_prize_df['р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н'] = pd.to_numeric(new_prize_df['р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н'], errors='coerce').fillna(0).astype(int)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.prize_df = new_prize_df # р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕Вр╣Йр╕▓ Session State р╣Вр╕Фр╕вр╕Хр╕гр╕З
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.success("р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╣Др╕Яр╕ер╣Мр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Нр╕кр╕│р╣Ар╕гр╣Зр╕И!")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а uploaded_count += 1
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а except Exception as e:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.error(f"р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕нр╣Ир╕▓р╕Щр╣Др╕Яр╕ер╣Мр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н: {e}")
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а # C. р╕гр╕╡р╣Вр╕лр╕ер╕Фр╣Бр╕нр╕Ыр╕лр╕▓р╕Бр╕бр╕╡р╕Бр╕▓р╕гр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕кр╕│р╣Ар╕гр╣Зр╕И
┬а ┬а ┬а ┬а ┬а ┬а if uploaded_count > 0:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.draw_history = []
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а save_history(st.session_state.draw_history) # р╕ер╣Йр╕▓р╕Зр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕кр╕╕р╣Ир╕б (р╣Др╕Яр╕ер╣М)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.selected_group = None
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.cache_data.clear()┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.rerun()
┬а ┬а ┬а ┬а ┬а ┬а else:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.warning("р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╕Ир╕░р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕Бр╣Ир╕нр╕Щ")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а st.markdown("---")
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а # *** р╕Ыр╕╕р╣Ир╕бр╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф (р╣Ар╕лр╕бр╕╖р╕нр╕Щр╣Ар╕Фр╕┤р╕б) ***
┬а ┬а ┬а ┬а st.markdown("### ЁЯТг р╕Бр╕▓р╕гр╕Др╕зр╕Ър╕Др╕╕р╕бр╕Вр╣Йр╕нр╕бр╕╣р╕е")
┬а ┬а ┬а ┬а if st.button("ЁЯФ┤ р╕ер╣Йр╕▓р╕Зр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕кр╕╕р╣Ир╕б", help="р╕Ир╕░р╕ер╕Ър╣Др╕Яр╕ер╣М draw_history.csv р╣Бр╕ер╕░р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╕кр╕╕р╣Ир╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф", use_container_width=True):
┬а ┬а ┬а ┬а ┬а ┬а if st.session_state.get('confirm_reset', False):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а reset_application()
┬а ┬а ┬а ┬а ┬а ┬а else:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.confirm_reset = True
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.warning("тЪая╕П р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Бр╕▓р╕гр╕ер╣Йр╕▓р╕Зр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╣Бр╕ер╕░р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╣Гр╕Кр╣Ир╕лр╕гр╕╖р╕нр╣Др╕бр╣И? (р╕Др╕ер╕┤р╕Бр╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕Зр╣Ар╕Юр╕╖р╣Ир╕нр╕вр╕╖р╕Щр╕вр╕▒р╕Щ)")
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а if st.session_state.get('confirm_reset', False) and not st.button("р╕вр╕Бр╣Ар╕ер╕┤р╕Бр╕Бр╕▓р╕гр╕вр╕╖р╕Щр╕вр╕▒р╕Щ", key="cancel_reset"):
┬а ┬а ┬а ┬а ┬а ┬а pass┬а
┬а ┬а ┬а ┬а elif st.session_state.get('confirm_reset', False) and st.button("р╕вр╕Бр╣Ар╕ер╕┤р╕Бр╕Бр╕▓р╕гр╕вр╕╖р╕Щр╕вр╕▒р╕Щ", key="cancel_reset"):
┬а ┬а ┬а ┬а ┬а ┬а st.session_state.confirm_reset = False
┬а ┬а ┬а ┬а ┬а ┬а st.rerun()


┬а ┬а ┬а ┬а st.markdown("---")
┬а ┬а ┬а ┬а st.markdown("### тП▒я╕Пр╕гр╕░р╕вр╕░р╣Ар╕зр╕ер╕▓р╣Бр╕кр╕Фр╕Зр╕Ьр╕е")
┬а ┬а ┬а ┬а default_speed = st.session_state.get('announcement_speed', 1.0)
┬а ┬а ┬а ┬а speed_control = st.slider(
┬а ┬а ┬а ┬а ┬а ┬а "р╕гр╕░р╕вр╕░р╣Ар╕зр╕ер╕▓р╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╕Ьр╕╣р╣Йр╣Вр╕Кр╕Др╕Фр╕╡ (р╕зр╕┤р╕Щр╕▓р╕Чр╕╡)",
┬а ┬а ┬а ┬а ┬а ┬а min_value=1.0,
┬а ┬а ┬а ┬а ┬а ┬а max_value=10.0,
┬а ┬а ┬а ┬а ┬а ┬а value=default_speed,
┬а ┬а ┬а ┬а ┬а ┬а step=0.5,
┬а ┬а ┬а ┬а ┬а ┬а key='announcement_speed'┬а
┬а ┬а ┬а ┬а )


┬а ┬а # ----------------------------------------------------
┬а ┬а # 2. р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕ер╕╕р╣Ир╕б
┬а ┬а # ----------------------------------------------------
┬а ┬а if st.session_state.emp_df.empty or st.session_state.prize_df.empty:
┬а ┬а ┬а ┬а st.error("р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕гр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕кр╕╕р╣Ир╕бр╣Др╕Фр╣Й р╣Ар╕Щр╕╖р╣Ир╕нр╕Зр╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щр╕лр╕гр╕╖р╕нр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Нр╣Др╕бр╣Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М (р╕Бр╕гр╕╕р╕Ур╕▓р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣Мр╣Гр╕лр╕бр╣И)")
┬а ┬а ┬а ┬а return┬а

┬а ┬а # р╕Бр╕│р╕лр╕Щр╕Фр╕ер╕│р╕Фр╕▒р╕Ър╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г
┬а ┬а CUSTOM_GROUP_ORDER = [
┬а ┬а ┬а ┬а 'р╕нр╕▓р╕вр╕╕р╕Зр╕▓р╕Щр╣Др╕бр╣Ир╕Цр╕╢р╕З 1 р╕Ыр╕╡',
┬а ┬а ┬а ┬а 'р╕нр╕▓р╕вр╕╕р╕Зр╕▓р╕Щ 1-5 р╕Ыр╕╡',
┬а ┬а ┬а ┬а 'р╕нр╕▓р╕вр╕╕р╕Зр╕▓р╕Щ 5-10 р╕Ыр╕╡',
┬а ┬а ┬а ┬а 'р╕нр╕▓р╕вр╕╕р╕Зр╕▓р╕Щ 10-15 р╕Ыр╕╡',
┬а ┬а ┬а ┬а 'р╕нр╕▓р╕вр╕╕р╕Зр╕▓р╕Щ 15-20 р╕Ыр╕╡',
┬а ┬а ┬а ┬а 'р╕нр╕▓р╕вр╕╕р╕Зр╕▓р╕Щ 20 р╕Ыр╕╡р╕Вр╕╢р╣Йр╕Щр╣Др╕Ы'
┬а ┬а ]

┬а ┬а groups_from_df = st.session_state.emp_df['р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е'].unique().tolist()
┬а ┬а groups_clean = [str(g).strip() for g in groups_from_df if pd.notna(g) and str(g).strip().lower() != "nan" and str(g).strip() != ""]
┬а ┬а┬а
┬а ┬а # р╕Ир╕▒р╕Фр╣Ар╕гр╕╡р╕вр╕Зр╕Бр╕ер╕╕р╣Ир╕бр╕Хр╕▓р╕бр╕ер╕│р╕Фр╕▒р╕Ър╕Чр╕╡р╣Ир╕Бр╕│р╕лр╕Щр╕Ф р╣Вр╕Фр╕вр╕Бр╕гр╕нр╕Зр╣Ар╕Йр╕Юр╕▓р╕░р╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕╡р╣Ир╕бр╕╡р╕нр╕вр╕╣р╣Ир╣Гр╕Щр╣Др╕Яр╕ер╣Мр╕Вр╣Йр╕нр╕бр╕╣р╕е
┬а ┬а groups = [g for g in CUSTOM_GROUP_ORDER if g in groups_clean]
┬а ┬а # р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕ер╕╕р╣Ир╕бр╕нр╕╖р╣Ир╕Щр╣Ж р╕Чр╕╡р╣Ир╕нр╕▓р╕Ир╣Др╕бр╣Ир╣Др╕Фр╣Йр╕нр╕вр╕╣р╣Ир╣Гр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕кр╕▒р╣Ир╕Зр╣Ар╕гр╕╡р╕вр╕Зр╣Др╕зр╣Йр╕Чр╕╡р╣Ир╕Чр╣Йр╕▓р╕вр╕кр╕╕р╕Ф (р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М)
┬а ┬а groups.extend([g for g in groups_clean if g not in CUSTOM_GROUP_ORDER])
┬а ┬а # ----------------------------------------------------
┬а ┬а┬а
┬а ┬а # ----------------------------------------------------
┬а ┬а # 3. CSS р╣Бр╕ер╕░ UI Main Body
┬а ┬а # ----------------------------------------------------
┬а ┬а BACKGROUND_IMAGE_FILE = 'background.jpg'┬а
┬а ┬а base64_bg = get_base64_image(BACKGROUND_IMAGE_FILE)

┬а ┬а if base64_bg:
┬а ┬а ┬а ┬а background_css = f"""
┬а ┬а ┬а ┬а .stApp {{┬а
┬а ┬а ┬а ┬а ┬а ┬а background-image: url("{base64_bg}");┬а
┬а ┬а ┬а ┬а ┬а ┬а background-size: cover;┬а
┬а ┬а ┬а ┬а ┬а ┬а background-attachment: fixed;
┬а ┬а ┬а ┬а ┬а ┬а background-position: center;
┬а ┬а ┬а ┬а }}
┬а ┬а ┬а ┬а """
┬а ┬а else:
┬а ┬а ┬а ┬а background_css = ".stApp { background-color: #0e1117; }"┬а
┬а ┬а ┬а ┬а┬а
┬а ┬а st.markdown(f"""
┬а ┬а ┬а ┬а <style>
┬а ┬а ┬а ┬а {background_css}
┬а ┬а ┬а ┬а .block-container {{┬а
┬а ┬а ┬а ┬а ┬а ┬а padding-top: 2rem;
┬а ┬а ┬а ┬а ┬а ┬а padding-bottom: 0rem;
┬а ┬а ┬а ┬а ┬а ┬а padding-left: 5rem;
┬а ┬а ┬а ┬а ┬а ┬а padding-right: 5rem;
┬а ┬а ┬а ┬а }}
┬а ┬а ┬а ┬а .main .block-container {{
┬а ┬а ┬а ┬а ┬а ┬а max-width: 1000px;┬а
┬а ┬а ┬а ┬а ┬а ┬а margin-left: auto;
┬а ┬а ┬а ┬а ┬а ┬а margin-right: auto;
┬а ┬а ┬а ┬а ┬а ┬а background-color: rgba(14, 17, 23, 0.9);┬а
┬а ┬а ┬а ┬а ┬а ┬а border-radius: 10px;
┬а ┬а ┬а ┬а ┬а ┬а padding: 20px;
┬а ┬а ┬а ┬а }}
┬а ┬а ┬а ┬а .success-box {{┬а
┬а ┬а ┬а ┬а ┬а ┬а background-color: #1a5631;┬а
┬а ┬а ┬а ┬а ┬а ┬а color: white;┬а
┬а ┬а ┬а ┬а ┬а ┬а padding: 15px;
┬а ┬а ┬а ┬а ┬а ┬а border-left: 6px solid #48a964;┬а
┬а ┬а ┬а ┬а ┬а ┬а border-radius: 5px;
┬а ┬а ┬а ┬а ┬а ┬а margin-bottom: 1rem;
┬а ┬а ┬а ┬а ┬а ┬а font-size: 2.5em;┬а
┬а ┬а ┬а ┬а ┬а ┬а font-weight: bold;
┬а ┬а ┬а ┬а ┬а ┬а text-align: center;┬а
┬а ┬а ┬а ┬а }}
┬а ┬а ┬а ┬а .stButton>button[key="main_draw_btn"] {{┬а
┬а ┬а ┬а ┬а ┬а ┬а background-color: #ff4b4b;
┬а ┬а ┬а ┬а ┬а ┬а color: white !important;
┬а ┬а ┬а ┬а ┬а ┬а border-radius: 8px;
┬а ┬а ┬а ┬а ┬а ┬а padding: 10px 20px;
┬а ┬а ┬а ┬а ┬а ┬а font-size: 1.2em;
┬а ┬а ┬а ┬а ┬а ┬а font-weight: bold;
┬а ┬а ┬а ┬а ┬а ┬а box-shadow: 0 4px 8px rgba(255, 75, 75, 0.4);
┬а ┬а ┬а ┬а ┬а ┬а transition: all 0.3s ease;
┬а ┬а ┬а ┬а }}
┬а ┬а ┬а ┬а .stButton>button[key^="group_btn_"] {{
┬а ┬а ┬а ┬а ┬а ┬а background-color: #3e4856 !important;┬а
┬а ┬а ┬а ┬а ┬а ┬а color: #4beaff !important;┬а
┬а ┬а ┬а ┬а ┬а ┬а border: 2px solid #4beaff;
┬а ┬а ┬а ┬а ┬а ┬а border-radius: 20px;
┬а ┬а ┬а ┬а ┬а ┬а padding: 8px 15px;
┬а ┬а ┬а ┬а ┬а ┬а font-size: 1.1em;
┬а ┬а ┬а ┬а ┬а ┬а font-weight: bold;
┬а ┬а ┬а ┬а ┬а ┬а box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
┬а ┬а ┬а ┬а ┬а ┬а transition: all 0.2s;
┬а ┬а ┬а ┬а }}
┬а ┬а ┬а ┬а .stButton>button[key^="group_btn_"]:hover {{
┬а ┬а ┬а ┬а ┬а ┬а background-color: #4beaff !important;
┬а ┬а ┬а ┬а ┬а ┬а color: #0e1117 !important;
┬а ┬а ┬а ┬а }}
┬а ┬а ┬а ┬а h1 {{
┬а ┬а ┬а ┬а ┬а ┬а color: #4beaff;┬а
┬а ┬а ┬а ┬а ┬а ┬а text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
┬а ┬а ┬а ┬а ┬а ┬а text-align: center;┬а
┬а ┬а ┬а ┬а }}
┬а ┬а ┬а ┬а h2 {{
┬а ┬а ┬а ┬а ┬а ┬а text-align: center;┬а
┬а ┬а ┬а ┬а }}
┬а ┬а ┬а ┬а </style>
┬а ┬а ┬а ┬а """, unsafe_allow_html=True)
┬а ┬а┬а
┬а ┬а # ----------------------------------------------------
┬а ┬а # 4. р╣Бр╕кр╕Фр╕Зр╕Ьр╕е Title р╣Бр╕ер╕░р╕кр╣Ир╕зр╕Щр╣Ар╕ер╕╖р╕нр╕Бр╕Бр╕ер╕╕р╣Ир╕б
┬а ┬а # ----------------------------------------------------
┬а ┬а st.title(custom_title)
┬а ┬а st.markdown("---")
┬а ┬а st.markdown("## р╣Ар╕ер╕╖р╕нр╕Бр╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е")
┬а ┬а┬а
┬а ┬а n_groups = len(groups)
┬а ┬а┬а
┬а ┬а # р╕кр╕гр╣Йр╕▓р╕Зр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ыр╕╕р╣Ир╕бр╕Бр╕ер╕╕р╣Ир╕б
┬а ┬а if n_groups > 0:
┬а ┬а ┬а ┬а # р╕Бр╕│р╕лр╕Щр╕Фр╣Гр╕лр╣Йр╕Ыр╕╕р╣Ир╕бр╕нр╕вр╕╣р╣Ир╕Хр╕гр╕Зр╕Бр╕ер╕▓р╕Зр╣Вр╕Фр╕вр╕бр╕╡р╕Др╕нр╕ер╕▒р╕бр╕Щр╣М dummy р╕Лр╣Йр╕▓р╕вр╕Вр╕зр╕▓
┬а ┬а ┬а ┬а cols = st.columns(n_groups + 2)┬а
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а for i, group in enumerate(groups):
┬а ┬а ┬а ┬а ┬а ┬а with cols[i + 1]:┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if st.button(group, key=f"group_btn_{group}", help=f"р╕Др╕ер╕┤р╕Бр╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕ер╕╖р╕нр╕Бр╕Бр╕ер╕╕р╣Ир╕б {group} р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Хр╕гр╕╡р╕вр╕бр╕кр╕╕р╣Ир╕б", use_container_width=True):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.selected_group = group
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.rerun()┬а
┬а ┬а else:
┬а ┬а ┬а ┬а st.warning("р╣Др╕бр╣Ир╕Юр╕Ър╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕ер╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╣Гр╕Щр╣Др╕Яр╕ер╣Мр╕Вр╣Йр╕нр╕бр╕╣р╕е р╣Вр╕Ыр╕гр╕Фр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕нр╕ер╕▒р╕бр╕Щр╣М 'р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е' р╣Гр╕Щр╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╣Вр╕лр╕ер╕Ф/р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф")

┬а ┬а st.markdown("---")
┬а ┬а┬а
┬а ┬а # ----------------------------------------------------
┬а ┬а # 5. р╕Ыр╕╕р╣Ир╕бр╕кр╕╕р╣Ир╕бр╕лр╕ер╕▒р╕Бр╣Бр╕ер╕░р╣Бр╕кр╕Фр╕Зр╕Ьр╕е
┬а ┬а # ----------------------------------------------------
┬а ┬а if st.session_state.selected_group:
┬а ┬а ┬а ┬а selected_group = st.session_state.selected_group
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а col_dummy_left, col_btn_center, col_dummy_right = st.columns([1, 1, 1])
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а with col_btn_center:
┬а ┬а ┬а ┬а ┬а ┬а st.markdown(f"ЁЯТб р╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕╡р╣Ир╕Юр╕гр╣Йр╕нр╕бр╕кр╕╕р╣Ир╕б : ** <span style='color:#4beaff; font-weight:bold;'>{selected_group}</span>", unsafe_allow_html=True)

┬а ┬а ┬а ┬а ┬а ┬а if st.button(f"ЁЯФ┤ р╣Ар╕гр╕┤р╣Ир╕бр╕кр╕╕р╣Ир╕бр╕гр╕▓р╕Зр╕зр╕▒р╕ер╕Бр╕ер╕╕р╣Ир╕б : **{selected_group}**", key="main_draw_btn", use_container_width=True):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а draw_results = run_draw(selected_group, st.session_state.emp_df, st.session_state.prize_df)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ROLLING_DURATION = 0.3┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ANNOUNCEMENT_DURATION = st.session_state.get('announcement_speed', 3.0)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if draw_results:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.subheader(f"р╣Ар╕гр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕кр╕╕р╣Ир╕бр╕Бр╕ер╕╕р╣Ир╕б **{selected_group}**")┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а current_winner_box = st.empty()┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.balloons()┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а time.sleep(1)┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а for i, item in enumerate(draw_results):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕З: ((р╕Кр╕╖р╣Ир╕н, р╣Бр╕Ьр╕Щр╕Б), р╕Кр╕╖р╣Ир╕нр╕гр╕▓р╕Зр╕зр╕▒р╕е)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а (winner_name, winner_dept), prize = item┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а except (ValueError, TypeError):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.error(f"р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Чр╕╡р╣И {i+1} : {item}")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а continue
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # A. Show rolling animation┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а with current_winner_box.container():
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.markdown(f"## р╕Бр╕│р╕ер╕▒р╕Зр╕кр╕╕р╣Ир╕бр╕Ьр╕╣р╣Йр╣Вр╕Кр╕Др╕Фр╕╡ **{i+1}**...")┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а time.sleep(ROLLING_DURATION)┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # B. Announce Winner
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а with current_winner_box.container():
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а winner_message = f"""
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class='success-box'>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <span style='font-size: 1.0em; font-weight: normal;'>ЁЯОК р╕Ьр╕╣р╣Йр╣Вр╕Кр╕Др╕Фр╕╡р╕Др╕╖р╕н ЁЯОК</span><br>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <span style='font-size: 0.8em; color: #ffeb3b;'> {winner_name} </span><br>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <span style='font-size: 1.0em; color: #ffffff;'> р╣Др╕Фр╣Йр╕гр╕▒р╕Ъ: {prize} </span>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а """
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.markdown(winner_message, unsafe_allow_html=True)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.markdown("---")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # C. р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░ (р╣Гр╕Щ Session State)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а emp_df_copy = st.session_state.emp_df.copy()
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а prize_df_copy = st.session_state.prize_df.copy()
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░р╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щ
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а idx_emp = emp_df_copy.index[emp_df_copy['р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е'] == winner_name].tolist()
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if idx_emp:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а emp_df_copy.loc[idx_emp[0], 'р╕кр╕Цр╕▓р╕Щр╕░'] = 'р╣Др╕Фр╣Йр╕гр╕▒р╕Ър╣Бр╕ер╣Йр╕з'
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.emp_df = emp_df_copy┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░р╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н (р╕ер╕Фр╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н 1 р╕лр╕Щр╣Ир╕зр╕в р╣Вр╕Фр╕вр╣Гр╕Кр╣Йр╕Кр╕╖р╣Ир╕нр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а idx_prize = prize_df_copy.index[
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а (prize_df_copy['р╕Кр╕╖р╣Ир╕нр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н'] == prize) &┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а (prize_df_copy['р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е'] == selected_group) &┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а (prize_df_copy['р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н'] > 0)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ].tolist()
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if idx_prize:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а first_idx = idx_prize[0]┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а current_qty = prize_df_copy.loc[first_idx, 'р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н']
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а prize_df_copy.loc[first_idx, 'р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н'] = current_qty - 1
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.prize_df = prize_df_copy┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # D. р╣Ар╕Бр╣Зр╕Ър╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╣Бр╕ер╕░р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕ер╕Зр╣Др╕Яр╕ер╣М
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а new_record = {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е': winner_name,┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╣Бр╕Ьр╕Щр╕Б': winner_dept,┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Вр╕нр╕Зр╕Вр╕зр╕▒р╕Н': prize,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕е': selected_group┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.draw_history.append(new_record)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а save_history(st.session_state.draw_history)┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а time.sleep(ANNOUNCEMENT_DURATION)┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а current_winner_box.empty() # р╕ер╣Йр╕▓р╕Зр╕Бр╕ер╣Ир╕нр╕Зр╣Бр╕кр╕Фр╕Зр╕Ьр╕╣р╣Йр╣Вр╕Кр╕Др╕Фр╕╡р╕Др╕Щр╕ер╣Ир╕▓р╕кр╕╕р╕Ф
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.balloons()
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # *** р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Бр╕кр╕Фр╕Зр╕Др╕зр╕▓р╕бр╕вр╕┤р╕Щр╕Фр╕╡р╣Бр╕ер╕░р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Бр╕▓р╕гр╕Ир╕Ър╕Бр╕▓р╕гр╕кр╕╕р╣Ир╕б ***
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.success(f"ЁЯОЙ р╕Бр╕▓р╕гр╕кр╕╕р╣Ир╕бр╕гр╕▓р╕Зр╕зр╕▒р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕ер╕╕р╣Ир╕б **{selected_group}** р╣Ар╕кр╕гр╣Зр╕Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣Мр╣Бр╕ер╣Йр╕з! ")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а else:
┬а ┬а ┬а ┬а st.info("р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕Бр╕ер╕╕р╣Ир╕бр╕Ир╕▒р╕Ър╕гр╕▓р╕Зр╕зр╕▒р╕ер╕Ир╕▓р╕Бр╕Ыр╕╕р╣Ир╕бр╕Фр╣Йр╕▓р╕Щр╕Ър╕Щр╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕гр╕┤р╣Ир╕бр╕кр╕╕р╣Ир╕б")
┬а ┬а ┬а ┬а┬а
┬а ┬а st.markdown("---")
┬а ┬а┬а
if __name__ == '__main__':
┬а ┬а # Initial check and setup for draw_history
┬а ┬а if 'draw_history' not in st.session_state:
┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а ┬аif os.path.exists(HISTORY_FILE):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.draw_history = pd.read_csv(HISTORY_FILE).to_dict('records')
┬а ┬а ┬а ┬а ┬а ┬а ┬аelse:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.draw_history = []
┬а ┬а ┬а ┬а except:
┬а ┬а ┬а ┬а ┬а ┬а ┬аst.session_state.draw_history = []

┬а ┬а main()







